# План реализации SSH Agent с LLM

## Обзор проекта

Проект представляет собой автоматизированную систему для выполнения задач на удаленных серверах через SSH с использованием LLM для планирования и выполнения команд. Система включает в себя многоуровневое планирование, автоматическую коррекцию ошибок и обратную связь с пользователем.

## Архитектура системы

### Основные компоненты

1. **Task Master** - интеграция с [light-task-master](https://github.com/mrsions/light-task-master) для улучшения промтов
2. **Config Server** - конфигурация сервера и параметров
3. **LLM Instructions** - инструкции для работы с LLM
4. **Planning Model** - модель высокоуровневого планирования (основные шаги)
5. **Small-step Planning Model** - модель детального планирования (малые шаги)
6. **SSH Connector** - подключение к серверу
7. **Execution Model** - выполнение команд (выполнение малых шагов)
8. **Error Handler** - обработка ошибок и обратная связь

## Структура проекта

```
agent_ssh_dev/
├── src/
│   ├── agents/
│   │   ├── task_master_integration.py  # Интеграция с light-task-master
│   │   ├── task_agent.py               # Модель планирования (основные шаги)
│   │   ├── subtask_agent.py            # Модель планирования малых шагов
│   │   ├── executor.py                 # Модель выполнения малых шагов
│   │   └── error_handler.py
│   ├── connectors/
│   │   └── ssh_connector.py
│   ├── models/
│   │   ├── planning_model.py           # Высокоуровневое планирование
│   │   └── execution_model.py          # Выполнение команд
│   ├── config/
│   │   ├── server_config.py
│   │   └── agent_config.py
│   ├── utils/
│   │   ├── logger.py
│   │   ├── validator.py
│   │   └── formatter.py
│   └── main.py
├── .taskmaster/                        # Конфигурация Task Master
│   ├── docs/
│   │   └── prd.txt                     # Product Requirements Document
│   ├── tasks/
│   └── templates/
├── config/
│   ├── server_config.yaml
│   └── agent_config.yaml
├── tests/
│   ├── test_agents/
│   ├── test_connectors/
│   └── test_models/
├── docs/
│   ├── api.md
│   ├── examples.md
│   └── taskmaster_integration.md
├── requirements.txt
├── package.json                        # Для Task Master
├── README.md
└── setup.py
```

## Пошаговый план реализации

### Этап 1: Настройка окружения и базовая структура

#### Шаг 1.1: Создание структуры проекта
- [ ] Создать основную структуру директорий
- [ ] Настроить виртуальное окружение Python
- [ ] Создать файл requirements.txt с базовыми зависимостями
- [ ] Настроить .gitignore для Python проекта
- [ ] Установить и настроить Task Master (npm install task-master-ai)
- [ ] Создать package.json для Node.js зависимостей
- [ ] Инициализировать Task Master в проекте (task-master init)

#### Шаг 1.2: Базовая конфигурация
- [ ] Создать конфигурационные файлы (YAML)
- [ ] Реализовать классы для загрузки конфигурации
- [ ] Настроить систему логирования

#### Шаг 1.3: SSH подключение
- [ ] Реализовать SSH Connector с использованием paramiko
- [ ] Добавить поддержку различных методов аутентификации
- [ ] Реализовать безопасное хранение учетных данных

### Этап 2: Реализация агентов планирования

#### Шаг 2.1: Task Master Integration
- [ ] Создать класс TaskMasterIntegration для работы с light-task-master
- [ ] Интегрировать Task Master API для улучшения промтов
- [ ] Реализовать парсинг PRD (Product Requirements Document)
- [ ] Настроить генерацию задач из PRD
- [ ] Реализовать валидацию и форматирование промтов через Task Master

#### Шаг 2.2: Task Agent (Модель планирования - основные шаги)
- [ ] Реализовать разбиение задач на основные шаги
- [ ] Добавить систему идентификации шагов (step_id)
- [ ] Создать интерфейс для взаимодействия с LLM
- [ ] Интегрировать с Task Master для получения улучшенных промтов

#### Шаг 2.3: Subtask Agent (Модель планирования малых шагов)
- [ ] Реализовать разбиение шагов на подзадачи
- [ ] Добавить генерацию команд Linux
- [ ] Реализовать систему health-check для команд
- [ ] Использовать Task Master для детализации планов

### Этап 3: Система выполнения

#### Шаг 3.1: Execution Model (Модель выполнения малых шагов)
- [ ] Создать класс для выполнения команд
- [ ] Реализовать последовательное выполнение подзадач
- [ ] Добавить сбор stdout/stderr и exit codes
- [ ] Интегрировать с Task Master для отслеживания прогресса

#### Шаг 3.2: Автокоррекция
- [ ] Реализовать систему локальных попыток исправления
- [ ] Добавить стратегии автокоррекции:
  - Проверка синтаксических ошибок
  - Добавление apt update перед установкой
  - Альтернативные флаги команд
  - Проверка сетевого соединения
  - Перезапуск сервисов

#### Шаг 3.3: Система подсчета ошибок
- [ ] Реализовать счетчик ошибок на уровне шага
- [ ] Добавить пороговые значения для эскалации
- [ ] Создать систему трекинга попыток

### Этап 4: Обработка ошибок и обратная связь

#### Шаг 4.1: Error Handler
- [ ] Создать класс для агрегации ошибок
- [ ] Реализовать формирование отчетов для планировщика
- [ ] Добавить сбор снимков состояния сервера

#### Шаг 4.2: Система эскалации
- [ ] Реализовать отправку логов планировщику при превышении порога
- [ ] Добавить механизм пересмотра планов
- [ ] Создать систему эскалации к человеку-оператору

#### Шаг 4.3: Обратная связь с пользователем
- [ ] Реализовать систему уведомлений
- [ ] Добавить детальные отчеты о выполнении
- [ ] Создать timeline выполнения задач

### Этап 5: Безопасность и валидация

#### Шаг 5.1: Система безопасности
- [ ] Реализовать проверку запрещенных команд
- [ ] Добавить валидацию команд перед выполнением
- [ ] Создать систему логирования попыток выполнения запрещенных команд

#### Шаг 5.2: Идемпотентность
- [ ] Реализовать генерацию идемпотентных команд
- [ ] Добавить проверки на повторное выполнение
- [ ] Создать систему отката изменений

#### Шаг 5.3: Dry-run режим
- [ ] Реализовать режим симуляции выполнения
- [ ] Добавить предварительный просмотр команд
- [ ] Создать систему валидации планов

### Этап 6: Интеграция и тестирование

#### Шаг 6.1: Интеграция компонентов
- [ ] Создать главный класс приложения
- [ ] Реализовать координацию между агентами
- [ ] Добавить систему управления состоянием

#### Шаг 6.2: Тестирование
- [ ] Создать unit тесты для всех компонентов
- [ ] Реализовать интеграционные тесты
- [ ] Добавить тесты для сценариев ошибок

#### Шаг 6.3: Документация и примеры
- [ ] Создать API документацию
- [ ] Добавить примеры использования
- [ ] Написать руководство по настройке

### Этап 7: Пользовательский интерфейс

#### Шаг 7.1: CLI интерфейс
- [ ] Создать командную строку с argparse
- [ ] Добавить интерактивный режим
- [ ] Реализовать конфигурацию через CLI

#### Шаг 7.2: Веб-интерфейс (опционально)
- [ ] Создать простой веб-интерфейс с Flask/FastAPI
- [ ] Добавить мониторинг выполнения задач
- [ ] Реализовать управление конфигурацией

### Этап 8: Оптимизация и мониторинг

#### Шаг 8.1: Производительность
- [ ] Оптимизировать работу с LLM API
- [ ] Добавить кэширование результатов планирования
- [ ] Реализовать параллельное выполнение независимых задач

#### Шаг 8.2: Мониторинг
- [ ] Добавить метрики выполнения
- [ ] Реализовать систему алертов
- [ ] Создать дашборд для мониторинга

## Конфигурационные параметры

### server_config.yaml
```yaml
server:
  host: "example.com"
  port: 22
  username: "user"
  auth_method: "key"  # key, password
  key_path: "/path/to/private/key"
  timeout: 30
  os_type: "ubuntu"  # ubuntu, centos, debian
  forbidden_commands:
    - "rm -rf /"
    - "dd if=/dev/zero"
    - "mkfs"
  installed_services:
    - "docker"
    - "nginx"
    - "postgresql"
```

### agent_config.yaml
```yaml
agents:
  taskmaster:
    enabled: true
    model: "gpt-4"
    temperature: 0.7
  
  task_agent:
    model: "gpt-4"
    temperature: 0.3
    max_steps: 10
  
  subtask_agent:
    model: "gpt-4"
    temperature: 0.1
    max_subtasks: 20
  
  executor:
    max_retries_per_command: 2
    auto_correction_enabled: true
    dry_run_mode: false
  
  error_handler:
    error_threshold_per_step: 4
    send_to_planner_after_threshold: true
    human_escalation_threshold: 3

llm:
  api_key: "your-api-key"
  base_url: "https://api.openai.com/v1"
  max_tokens: 4000
  timeout: 60
```

## Примеры использования

### Базовое использование
```python
from agent_ssh_dev import SSHAgent

# Инициализация агента
agent = SSHAgent(
    server_config="config/server_config.yaml",
    agent_config="config/agent_config.yaml"
)

# Выполнение задачи
result = agent.execute_task("Установить и настроить PostgreSQL на сервере")
print(result)
```

### Расширенное использование
```python
# Создание кастомной конфигурации
config = {
    "error_threshold_per_step": 3,
    "auto_correction_enabled": True,
    "dry_run_mode": False
}

agent = SSHAgent(config=config)
result = agent.execute_task(
    "Настроить веб-сервер с SSL сертификатом",
    dry_run=True  # Предварительный просмотр
)
```

## Критерии успеха

1. **Функциональность**: Система успешно выполняет 90%+ задач без вмешательства человека
2. **Надежность**: Автокоррекция решает 80%+ ошибок автоматически
3. **Безопасность**: 0% выполнения запрещенных команд
4. **Производительность**: Выполнение задач в разумные сроки (зависит от сложности)
5. **Удобство**: Простой и понятный интерфейс для пользователя

## Риски и митигация

### Основные риски:
1. **Ошибки LLM**: Неправильное планирование или выполнение команд
   - *Митигация*: Многоуровневая валидация, автокоррекция, эскалация к человеку

2. **Безопасность**: Выполнение опасных команд
   - *Митигация*: Строгий список запрещенных команд, dry-run режим

3. **Производительность**: Медленная работа с LLM API
   - *Митигация*: Кэширование, оптимизация запросов, локальные модели

4. **Совместимость**: Проблемы с различными ОС и конфигурациями
   - *Митигация*: Тестирование на разных системах, адаптивные стратегии

## Заключение

Данный план обеспечивает поэтапную реализацию сложной системы автоматизации с использованием LLM. Каждый этап строится на предыдущем, что позволяет постепенно наращивать функциональность и тестировать компоненты по мере разработки.

Ключевые принципы реализации:
- Модульность и расширяемость
- Безопасность и надежность
- Прозрачность и контролируемость
- Простота использования и настройки
